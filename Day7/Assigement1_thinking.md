# malloc challenge: Best-Fit Allocator with Bin-based Free List

## 概要
以下の2点の最適化を実装した

1. **Best-Fit アルゴリズム** の採用  
2. **サイズ分割された Bin-based Free List** の導入

---

## 実装した変更点

### 1. Best-Fit アルゴリズムへの変更

元の戦略では、結果的に大きな空き領域が早く消費され、断片化の原因になりやすい

そこで、**すべての適合候補の中から最もサイズの近い（無駄が最小の）free block を選ぶ** Best-fit に改良した

#### Best-fit malloc 実装の具体的変更点

##### 1. サイズに応じたビン分割

- 空き領域をサイズごとに10個のビン（bins）で管理  
- ビンのサイズは8バイトから始まり、2倍ずつ大きくなる  
- 例:  
  - bin 0: 8バイトまで  
  - bin 1: 9〜16バイトまで  
  - bin 2: 17〜32バイトまで  
  - ...  

##### 2. Best-fitアルゴリズムの導入

- 要求サイズに対応するビンから探索を開始し、それ以降の大きいサイズのビンも順に確認
- 各ビンの空きリストを先頭から順に走査し、「要求サイズ以上で最もサイズ差（空き領域サイズ - 要求サイズ）が小さい空き領域」を探索  
- ぴったりサイズが見つかれば即座に決定 

##### 3. 割り当てと空き領域の分割

- Best-fitで見つけた空き領域（`best_fit`）は、まず空きリストから除外  
- 次に、要求サイズに対して空き領域のサイズが大きければ、割り当て部分と余りの部分に分割  

-  分割の詳細
    - `best_fit->size` が要求サイズ `size` より大きい場合、割り当て領域は `size` バイト分に縮小
    - 余った部分は新たな空き領域として `my_metadata_t` 構造体を付けて管理  
    - 余りのサイズが `sizeof(my_metadata_t)` よりも小さい場合、分割は行わず、割り当て領域全体をそのまま使用

### 2. Bin-based Free List の実装

空き領域をサイズに応じて10段階の「ビン（bins）」に分類し、それぞれのビンにリンクリストを使って管理することで、検索空間を削減した

- **Binの分け方**：
  - 8, 16, 32, ..., 最大で 2048バイト以上の bin に分類
  - `get_bin_index(size)` 関数で、対応する bin を取得

- **挿入（free）時**は、対応 bin の先頭に挿入
- **割当（malloc）時**は、該当サイズの bin から順にスキャンして Best-fit を選択

### 3. malloc失敗時の動的確保

既存のbinに適合するブロックがなければ `mmap_from_system(4096)` で新たなチャンクを確保し、free list に追加して再試行するようにした

---